FROM python:3.11-slim

# Set working directory
WORKDIR /app

# System dependencies
RUN apt-get update && apt-get install -y \
    sqlite3 curl git && \
    rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt /app/requirements.txt

# Install Python deps
RUN pip install --no-cache-dir -r requirements.txt

# Copy mesh source
COPY db/ /app/db/
COPY notify.py /app/notify.py
COPY scheduler.py /app/scheduler.py
COPY server.py /app/server.py
COPY mcp_client.py /app/mcp_client.py
COPY templates/ /app/templates/          
# ADDED: Templates required by notify.py



# Default SQLite location inside container
ENV SQLITE_PATH=/data/mesh.db


# Expose public mesh control API
EXPOSE 8091

# Entrypoint (runs DB init + scheduler + API)
# Entrypoint (runs DB init + API with integrated scheduler)
CMD ["sh", "-c", "\
    if [ ! -f /data/mesh.db ]; then \
        echo 'Initializing SQLite DB...'; \
        mkdir -p /data && \
        sqlite3 /data/mesh.db < /app/db/schema.sql; \
    else \
        echo 'SQLite DB already exists'; \
    fi; \
    echo 'Starting MCP Mesh Core...'; \
    # FIX: Run Uvicorn in the foreground (no '&' or 'python scheduler.py')
    uvicorn server:app --host 0.0.0.0 --port 8091 \
"]
