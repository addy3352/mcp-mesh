version: "3.9"

services:
  mesh-core:
    build:
      context: .
      dockerfile: Dockerfile.mesh
    container_name: mesh-core
    restart: unless-stopped
    env_file: /opt/mcp-mesh/.env.mesh
    volumes:
      - meshdata:/data
    networks:
      - mcpnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  mesh-gateway:
    build: ./mesh-gateway
    container_name: mesh-gateway
    env_file: /opt/mcp-mesh/.env.mesh
    volumes:
      - ./mesh-gateway/policy.yaml:/app/policy.yaml:ro
      - meshdata:/data
    ports:
      - "8090:8090"
    restart: unless-stopped
    networks:
      - mcpnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mcp-garmin:
    build: 
       context: .
       dockerfile: mcp-garmin/Dockerfile
    container_name: mcp-garmin
    env_file: /opt/mcp-mesh/.env.mesh
    volumes:
      - meshdata:/data
    restart: unless-stopped
    networks:
      - mcpnet
    depends_on:
      mesh-core:
        condition: service_healthy

  mcp-nutrition:
    build:
      context: .
      dockerfile: mcp-nutrition/Dockerfile
    container_name: mcp-nutrition
    env_file: /opt/mcp-mesh/.env.mesh
    volumes:
      - meshdata:/data
      - ./mcp-nutrition/prompt.txt:/app/prompt.txt
    restart: unless-stopped
    networks:
      - mcpnet

  mcp-linkedin:
    build: ./mcp-linkedin
    container_name: mcp-linkedin
    env_file: /opt/mcp-mesh/.env.mesh
    restart: unless-stopped
    networks:
      - mcpnet

  mcp-portal:
    build: ./mcp-portal
    container_name: mcp-portal
    env_file: /opt/mcp-mesh/.env.mesh
    restart: unless-stopped
    networks:
      - mcpnet

  mcp-agent-health:
    build: ./mcp-agent_health
    container_name: mcp-agent_health
    env_file: /opt/mcp-mesh/.env.mesh
    volumes:
      - meshdata:/data
      - ./mcp-agent_health/prompt.txt:/app/prompt.txt
    restart: unless-stopped
    networks:
      - mcpnet
    depends_on:
      mesh-gateway:
        condition: service_healthy
      mcp-garmin:
        condition: service_started
      mcp-nutrition:
        condition: service_started

  nginx:
    image: nginx:latest
    container_name: mesh-nginx
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - /etc/letsencrypt:/etc/letsencrypt:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      mesh-gateway:
        condition: service_healthy
    networks:
      - mcpnet

networks:
  mcpnet:

volumes:
  meshdata: